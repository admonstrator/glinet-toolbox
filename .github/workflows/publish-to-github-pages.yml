name: Publish README to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'README.md'
      - 'images/**'
      - '.github/workflows/publish-to-github-pages.yml'
  workflow_dispatch:  # Allows manual triggering

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Convert README to HTML
        run: |
          # Install pandoc for markdown to HTML conversion
          sudo apt-get update
          sudo apt-get install -y pandoc
          
          # Create output directory
          mkdir -p _site
          
          # Create HTML template
          cat > /tmp/template.html << 'EOF'
          <!DOCTYPE html>
          <html xmlns="http://www.w3.org/1999/xhtml" lang="$lang$" xml:lang="$lang$"$if(dir)$ dir="$dir$"$endif$>
          <head>
            <meta charset="utf-8" />
            <meta name="generator" content="pandoc" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
          $for(author-meta)$
            <meta name="author" content="$author-meta$" />
          $endfor$
          $if(date-meta)$
            <meta name="dcterms.date" content="$date-meta$" />
          $endif$
          $if(keywords)$
            <meta name="keywords" content="$for(keywords)$$keywords$$sep$, $endfor$" />
          $endif$
          $if(description-meta)$
            <meta name="description" content="$description-meta$" />
          $endif$
            <title>$if(title-prefix)$$title-prefix$ – $endif$$pagetitle$</title>
          $for(css)$
            <link rel="stylesheet" href="$css$" />
          $endfor$
            <style>
              body {
                margin: 0;
                padding: 0;
                background-color: #0d1117;
              }
              .markdown-body {
                box-sizing: border-box;
                min-width: 200px;
                max-width: 980px;
                margin: 0 auto;
                padding: 45px;
                background-color: #0d1117;
                color: #c9d1d9;
              }
              @media (max-width: 767px) {
                .markdown-body {
                  padding: 15px;
                }
              }
              .markdown-body img {
                max-width: 100%;
                height: auto;
              }
            </style>
          $for(header-includes)$
            $header-includes$
          $endfor$
          </head>
          <body>
          $for(include-before)$
          $include-before$
          $endfor$
          <article class="markdown-body">
          $if(title)$
          <header id="title-block-header">
          <h1 class="title">$title$</h1>
          $if(subtitle)$
          <p class="subtitle">$subtitle$</p>
          $endif$
          $for(author)$
          <p class="author">$author$</p>
          $endfor$
          $if(date)$
          <p class="date">$date$</p>
          $endif$
          </header>
          $endif$
          $if(toc)$
          <nav id="$idprefix$TOC" role="doc-toc">
          $if(toc-title)$
          <h2 id="$idprefix$toc-title">$toc-title$</h2>
          $endif$
          $table-of-contents$
          </nav>
          $endif$
          $body$
          </article>
          $for(include-after)$
          $include-after$
          $endfor$
          </body>
          </html>
          EOF
          
          # Convert README.md to index.html with proper HTML5 structure
          pandoc README.md \
            -f gfm \
            -t html5 \
            -s \
            --metadata title="GL.iNet Toolbox" \
            --css="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown.min.css" \
            --template=/tmp/template.html \
            -o _site/index.html
          
          echo "✅ Successfully converted README.md to index.html"
      
      - name: Copy images to site
        run: |
          cp -r images _site/
          echo "✅ Copied images directory to _site"
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
