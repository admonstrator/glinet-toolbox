name: Update Repository Badges

on:
  workflow_dispatch:  # Manually triggered
  schedule:
    - cron: '0 0 * * 0'  # Run weekly on Sunday at midnight

jobs:
  update-badges:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Fetch repository statistics
        id: stats
        run: |
          # Function to get repo stats
          get_repo_stats() {
            local repo=$1
            echo "Fetching stats for $repo..." >&2
            
            # Get repository data
            response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/Admonstrator/$repo")
            
            # Use 0 as default if the key is missing or null
            stars=$(echo "$response" | jq -r 'if .stargazers_count == null then 0 else .stargazers_count end')
            forks=$(echo "$response" | jq -r 'if .forks_count == null then 0 else .forks_count end')
            
            # Get latest release
            release_response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/Admonstrator/$repo/releases/latest")
            
            latest_release=$(echo "$release_response" | jq -r '.tag_name // "N/A"')
            
            echo "${repo}_stars=$stars" >> $GITHUB_OUTPUT
            echo "${repo}_forks=$forks" >> $GITHUB_OUTPUT
            echo "${repo}_release=$latest_release" >> $GITHUB_OUTPUT
          }
          
          # Fetch stats for all repos
          get_repo_stats "glinet-tailscale-updater"
          get_repo_stats "glinet-adguard-updater"
          get_repo_stats "glinet-enable-acme"
          get_repo_stats "glinet.forum"
          get_repo_stats "can-i-haz-reachability"
          get_repo_stats "glinet-firmware-overview"
      
      - name: Generate README from template
        run: |
          # Helper function to create color based on count
          get_color() {
            local count=${1:-0}
            if [ "$count" -ge 300 ]; then echo "brightgreen"
            elif [ "$count" -ge 100 ]; then echo "green"
            elif [ "$count" -ge 50 ]; then echo "yellowgreen"
            elif [ "$count" -ge 10 ]; then echo "yellow"
            else echo "orange"
            fi
          }

          # Helper function to escape sed variables
          escape_sed() {
            echo "$1" | sed 's/[\/&]/\\&/g'
          }
          
          # Get all stats with defaults
          ts_stars="${{ steps.stats.outputs.glinet-tailscale-updater_stars }}"
          ts_stars=${ts_stars:-0}
          ts_forks="${{ steps.stats.outputs.glinet-tailscale-updater_forks }}"
          ts_forks=${ts_forks:-0}
          ts_release=$(escape_sed "${{ steps.stats.outputs.glinet-tailscale-updater_release }}")
          ts_color=$(get_color $ts_stars)
          
          ag_stars="${{ steps.stats.outputs.glinet-adguard-updater_stars }}"
          ag_stars=${ag_stars:-0}
          ag_forks="${{ steps.stats.outputs.glinet-adguard-updater_forks }}"
          ag_forks=${ag_forks:-0}
          ag_release=$(escape_sed "${{ steps.stats.outputs.glinet-adguard-updater_release }}")
          ag_color=$(get_color $ag_stars)
          
          acme_stars="${{ steps.stats.outputs.glinet-enable-acme_stars }}"
          acme_stars=${acme_stars:-0}
          acme_forks="${{ steps.stats.outputs.glinet-enable-acme_forks }}"
          acme_forks=${acme_forks:-0}
          acme_color=$(get_color $acme_stars)
          
          forum_stars="${{ steps.stats.outputs.glinet.forum_stars }}"
          forum_stars=${forum_stars:-0}
          forum_forks="${{ steps.stats.outputs.glinet.forum_forks }}"
          forum_forks=${forum_forks:-0}
          forum_color=$(get_color $forum_stars)
          
          reachability_stars="${{ steps.stats.outputs.can-i-haz-reachability_stars }}"
          reachability_stars=${reachability_stars:-0}
          reachability_forks="${{ steps.stats.outputs.can-i-haz-reachability_forks }}"
          reachability_forks=${reachability_forks:-0}
          reachability_color=$(get_color $reachability_stars)
          
          firmware_stars="${{ steps.stats.outputs.glinet-firmware-overview_stars }}"
          firmware_stars=${firmware_stars:-0}
          firmware_forks="${{ steps.stats.outputs.glinet-firmware-overview_forks }}"
          firmware_forks=${firmware_forks:-0}
          firmware_release=$(escape_sed "${{ steps.stats.outputs.glinet-firmware-overview_release }}")
          firmware_color=$(get_color $firmware_stars)
          
          # Calculate total stars safely
          total_stars=$((ts_stars + ag_stars + acme_stars + forum_stars + reachability_stars + firmware_stars))
          
          # Get current date
          update_date=$(date '+%Y-%m-%d')
          
          # Copy template and replace placeholders
          cp README.template.md README.md
          
          # Replace all placeholders
          sed -i "s/{{TAILSCALE_STARS}}/$ts_stars/g" README.md
          sed -i "s/{{TAILSCALE_FORKS}}/$ts_forks/g" README.md
          sed -i "s/{{TAILSCALE_RELEASE}}/$ts_release/g" README.md
          sed -i "s/{{TAILSCALE_STARS_COLOR}}/$ts_color/g" README.md
          
          sed -i "s/{{ADGUARD_STARS}}/$ag_stars/g" README.md
          sed -i "s/{{ADGUARD_FORKS}}/$ag_forks/g" README.md
          sed -i "s/{{ADGUARD_RELEASE}}/$ag_release/g" README.md
          sed -i "s/{{ADGUARD_STARS_COLOR}}/$ag_color/g" README.md
          
          sed -i "s/{{ACME_STARS}}/$acme_stars/g" README.md
          sed -i "s/{{ACME_FORKS}}/$acme_forks/g" README.md
          sed -i "s/{{ACME_STARS_COLOR}}/$acme_color/g" README.md
          
          sed -i "s/{{FORUM_STARS}}/$forum_stars/g" README.md
          sed -i "s/{{FORUM_FORKS}}/$forum_forks/g" README.md
          sed -i "s/{{FORUM_STARS_COLOR}}/$forum_color/g" README.md
          
          sed -i "s/{{REACHABILITY_STARS}}/$reachability_stars/g" README.md
          sed -i "s/{{REACHABILITY_FORKS}}/$reachability_forks/g" README.md
          sed -i "s/{{REACHABILITY_STARS_COLOR}}/$reachability_color/g" README.md
          
          sed -i "s/{{FIRMWARE_STARS}}/$firmware_stars/g" README.md
          sed -i "s/{{FIRMWARE_FORKS}}/$firmware_forks/g" README.md
          sed -i "s/{{FIRMWARE_RELEASE}}/$firmware_release/g" README.md
          sed -i "s/{{FIRMWARE_STARS_COLOR}}/$firmware_color/g" README.md
          
          sed -i "s/{{TOTAL_STARS}}/$total_stars/g" README.md
          sed -i "s/{{UPDATE_DATE}}/$update_date/g" README.md
          
          echo "âœ… README generated from template successfully"
      
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git commit -m "ðŸ¤– Update repository badges [automated]"
          git push
      
      - name: Create summary
        run: |
          echo "## ðŸ“Š Badge Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tailscale Updater" >> $GITHUB_STEP_SUMMARY
          echo "- â­ Stars: ${{ steps.stats.outputs.glinet-tailscale-updater_stars }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ´ Forks: ${{ steps.stats.outputs.glinet-tailscale-updater_forks }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Latest: ${{ steps.stats.outputs.glinet-tailscale-updater_release }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AdGuard Updater" >> $GITHUB_STEP_SUMMARY
          echo "- â­ Stars: ${{ steps.stats.outputs.glinet-adguard-updater_stars }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ´ Forks: ${{ steps.stats.outputs.glinet-adguard-updater_forks }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Latest: ${{ steps.stats.outputs.glinet-adguard-updater_release }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ACME Manager" >> $GITHUB_STEP_SUMMARY
          echo "- â­ Stars: ${{ steps.stats.outputs.glinet-enable-acme_stars }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ´ Forks: ${{ steps.stats.outputs.glinet-enable-acme_forks }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Forum Collection" >> $GITHUB_STEP_SUMMARY
          echo "- â­ Stars: ${{ steps.stats.outputs.glinet.forum_stars }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ´ Forks: ${{ steps.stats.outputs.glinet.forum_forks }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Can I Haz Reachability?" >> $GITHUB_STEP_SUMMARY
          echo "- â­ Stars: ${{ steps.stats.outputs.can-i-haz-reachability_stars }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ´ Forks: ${{ steps.stats.outputs.can-i-haz-reachability_forks }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Firmware Overview" >> $GITHUB_STEP_SUMMARY
          echo "- â­ Stars: ${{ steps.stats.outputs.glinet-firmware-overview_stars }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ´ Forks: ${{ steps.stats.outputs.glinet-firmware-overview_forks }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "âœ… **README.md was updated with new badge values**" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No changes detected - badges are up to date**" >> $GITHUB_STEP_SUMMARY
          fi
